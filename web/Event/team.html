<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="http://code.jquery.com/mobile/git/jquery.mobile-git.js"></script>
		<link rel="stylesheet" href="http://code.jquery.com/mobile/git/jquery.mobile-git.css" />
	</head>

	<body>
		<div data-role="page" id="team_view">
			<div data-role="header">
				<h1>队伍</h1>
				<a href="#team_view_panel" id="team_view_menu" data-theme="b" data-icon="gear" data-role="button" data-inline="true">                系统菜单</a>
				<a id="buttonToIndex" data-role="button" data-icon="home">返回</a>
			</div>
			
			<div data-role="panel" id="team_view_panel" data-theme="b">
				<div id="team_view_button_group" data-role="controlgroup" class="ui-controlgroup">
					<a href="#select_team" id="team_view_panel_select_team" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">查看队伍</a>
					<a href="#create_team" id="team_view_panel_create_team" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">创建队伍</a>
					<a href="#edit_group" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">创建/编辑 小组</a>
					<a href="#create_invit" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">发出邀请</a>
					<a href="#view_invit" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">查看邀请</a>
					<a href="#apply_team" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">申请加入小队</a>
					<a href="#check_team_recive" id="team_view_panel_check_team_recive" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">收到的加入申请</a>
					<a href="#check_team_send" id="team_view_panel_check_team_send" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">递出的加入申请</a>
					<a href="#out_team" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">转让队伍</a>
					<a href="#position_team" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">任命职务</a>
					<a href="#delete_team" data-rel="popup" data-position-to="#select_team" class="ui-btn ui-corner-all" style="text-align:left; ">解散队伍</a>
				</div>
			</div>
			
			<div data-role="popup" id="select_team" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<h3>查看队伍</h3>
					<ul id="teamArea" data-role="listview" data-filter="true" data-inset="true" data-filter-placeholder="可用队伍"></ul>
				</div>
			</div>
			
			<div data-role="popup" id="create_team" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<h3>新建一个队伍</h3>
					<label for="eventname">选择活动:</label>
					<select name="create_team_event" id="create_team_event">
						<option value="standard">Standard: 7 day</option>
						<option value="rush">Rush: 3 days</option>
						<option value="express">Express: next day</option>
						<option value="overnight">Overnight</option>
					</select>
					<label for="teamname">队伍名:</label>
					<input type="text" name="teamname" id="create_team_teamname" value="" data-theme="a">
					<label for="groupname">小队名:</label>
					<input type="text" name="groupname" id="create_team_groupname" value="デフォルト" data-theme="a" readonly="true">
					<button id="creatteambutton" data-theme="b" class=" ui-btn ui-btn-b ui-shadow ui-corner-all">创建</button>
				</div>
			</div>
			
			
			<div data-role="popup" id="create_invit" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<form>
						<h3>发出邀请</h3>
						<label for="create_invit_id">邀请对象用户ID:</label>
						<input type="text" name="create_invit_id" id="create_invit_id" value="" data-theme="a">
					</form>
					<button data-theme="b" class=" ui-btn ui-btn-b ui-shadow ui-corner-all">邀请</button>
				</div>
			</div>
			
			<div data-role="popup" id="view_invit" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<form>
						<h3>接收到的邀请</h3>
					</form>
				</div>
			</div>

			<div data-role="popup" id="apply_team" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<h3>申请加入队伍</h3>
					<label for="apply_team_id">对象队伍ID:</label>
					<input type="text" name="apply_team_id" id="apply_team_id" value="" data-theme="a">
					<button id="apply_team_button" data-theme="b" class=" ui-btn ui-btn-b ui-shadow ui-corner-all">申请</button>
				</div>
			</div>
			
			<div data-role="popup" id="check_team_recive" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<form>
						<h3>收到的加入申请</h3>
						<ul id="check_team_recive_ul" data-role="listview" data-filter="true" data-inset="true" data-filter-placeholder="检索"></ul>
					</form>
				</div>
			</div>
			
			<div data-role="popup" id="check_team_send" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<form>
						<h3>递出的加入申请</h3>
						<ul id="check_team_send_ul" data-role="listview" data-filter="true" data-inset="true" data-filter-placeholder="检索"></ul>
					</form>
				</div>
			</div>
			
			<div data-role="popup" id="delete_team" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
				<div style="padding:0px 5px;">
					<h3>解散队伍</h3>
					<button id="delete_team_check" data-theme="b" class=" ui-btn ui-btn-b ui-shadow ui-corner-all">解散</button>
				</div>
			</div>
			
			<div data-role="panel" id="member_panel" data-theme="b" data-position="right">
				<h3>成员操作</h3>
				<div id="member_group" data-inline="true">
				</div>
			</div>
			
			<div role="main" class="ui-content">
				<div id="teaminfo"></div>
				<ul id="memberArea" data-role="listview" data-filter="true" data-inset="true" data-filter-placeholder="队员检索"></ul>
			</div>
			
			<script>
				$(document).on("pagecontainerchange", function exe_when_pagecontainerchange() {
					$("#buttonToIndex").click(function() {
						window.location.assign("/eventselect");
					});
					
					$("#team_view_panel_select_team").click(function() {
						$.get("/team/view",
							function(resData, status) {
								makeUI(resData);
						});
					});
					
					var makeUI = function (resData) {
						$("#teamArea").text('');
						for(one in resData){
							$("#teamArea").append('<a id="team_select' + one +  '" class="ui-btn">'
								+ "活动:" + resData[one].EventName
								+ "<br>队伍名:" + resData[one].TeamName
								+ "<br>小组名:" + resData[one].GroupName
								+ '</a>');
							
							makeTeamClick(resData, one);
						}
					}
					
					var makeTeamClick = function(resData,one) {
						$("#team_select" + one).on( "vclick", function() {
							$.post("/team/select", {
									eventid : resData[one].EventID ,
									teamid : resData[one].TeamID
								},
								function selectevent(resdata, status) {
									alert("Data: " + resdata + "\nStatus: " + status);
									window.location.assign("/team");
								}
							);
						});
					}
					
					$.get("/team/member/view",
						function(resData, status) {
							makeMemberArea(resData);
					});
					
					var makeMemberArea = function (resData) {
						if(resData[0]){
							$("#teaminfo").html('<div>活动名: ' + resData[0].EventName +
													'<br>队伍ID: ' + resData[0].EventID + resData[0].TeamID +
													'<br>队伍名: ' + resData[0].TeamName + '</div>')
						}
						
						for (one in resData) {
							$("#memberArea").append('<a href="#member_panel" id="member' + resData[one].UserID +  '" class="ui-btn">'
								+ resData[one].UserNickName
							+ '</a>');
							//makeClick(resData[one], resData[one].UserID);
						}
					}
					
					
					$.get("/event/view",
						function(resData, status) {
							$("#creatteambutton").unbind("click");
							
							var select_str = ""
							for(one in resData){
								select_str += '<option value="' + resData[one].EventID + '">' + resData[one].EventName + '</option>'
							}
							$("#create_team_event").html(select_str);
							$("#create_team_event").selectmenu('refresh',true);
							
							$("#creatteambutton").click(function() {
								var s_envetid = $("#create_team_event").val();
								var s_teamname = $("#create_team_teamname").val();
								var s_groupname = $("#create_team_groupname").val();
								
								if ( s_teamname != "" &&
										s_groupname != "" ) {
											$.post("/team/create",{
												eventid : s_envetid ,
												teamname : s_teamname.replace(/'/g,"’") ,
												groupname : s_groupname.replace(/'/g,"’")
											},
											function(resData, status) {
												//alert("Data: " + resData + "\nStatus: " + status);
												window.location.assign("/team");
											});
								} else {
									alert("Check your input!");
								}
							});
							
							$("#delete_team_check").click(function() {
								var check = confirm("解散后将无法恢复！确定要删除么？");
								if ( check ) {
									$.get("/team/delete",
										function(resData, status) {
											alert("Data: " + resData + "\nStatus: " + status);
											window.location.assign("/team");
									});
								}
							});
							
							
							$("#apply_team_button").click(function() {
								var s_eventid = $("#apply_team_id").val().replace(/.{6}$/g,"");
								var s_teamid = $("#apply_team_id").val().replace(/^.{10}/g,"");
								$.post("/team/apply/new",{
										eventid : s_eventid ,
										teamid : s_teamid
									},function(resData, status) {
										alert("Data: " + resData + "\nStatus: " + status);
										window.location.assign("/team");
								});
							});
							
							
							$("#team_view_panel_check_team_recive").click(function() {
								$.get("/team/apply/recive",
										function(resData, status) {
											makeTeamRecive(resData);
								});
							});
							
							var makeTeamRecive = function (resData) {
								$("#check_team_recive_ul").text('');
								for(one in resData){
									$("#check_team_recive_ul").append('<a id="team_recive' + one +  '" class="ui-btn">'
										+ '发出者: ' + resData[one].UserNickName
										+ '<br>请求队伍ID: ' + resData[one].EventID + resData[one].TeamID
										+ '<br>状态: ' + resData[one].Status + '</a>');
									makeTeamReciveClick(resData, one);
								}
							}
							
							var makeTeamReciveClick = function(resData,one) {
								$("#team_recive" + one).on( "click", function() {
									var check = confirm("确定将" + resData[one].UserNickName + "加入队伍？");
									if ( check ) {
										$.post("/team/apply/yes", {
												target_userid : resData[one].UserID
											},
											function selectevent(resdata, status) {
												alert("Data: " + resdata + "\nStatus: " + status);
												window.location.assign("/team");
											}
										);
									}
								});
							}
							
							
							$("#team_view_panel_check_team_send").click(function() {
								$.get("/team/apply/send",
										function(resData, status) {
											makeTeamSend(resData);
								});
							});
							
							var makeTeamSend = function (resData) {
								$("#check_team_send_ul").text('');
								for(one in resData){
									$("#check_team_send_ul").append('<a id="team_recive' + one +  '" class="ui-btn">'
										+ '请求队伍ID: ' + resData[one].EventID + resData[one].TeamID
										+ '<br>状态: ' + resData[one].Status + '</a>');
									//makeTeamSendClick(resData, one);
								}
							}
							
							//var makeTeamSendClick = function(resData,one) {
							//	$("#team_recive" + one).on( "click", function() {
							//		$.post("/team/apply/delete", {
							//				eventid : s_eventid ,
							//				teamid : s_teamid
							//			},
							//			function selectevent(resdata, status) {
							//				alert("Data: " + resdata + "\nStatus: " + status);
							//				window.location.assign("/team");
							//			}
							//		);
							//	});
							//}
					});
					
					
					//release
					$(document).unbind("pagecontainerchange");
				});

				 //ajax跨域对应 Start
				$.ajaxSetup({
					xhrFields: {
						withCredentials: true
					}
				});
				
			</script>
		</div>
	</body>

</html>